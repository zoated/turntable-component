{"version":3,"file":"getTagProcessor.js","names":["readFileSync","basename","dirname","join","types","t","addDefault","addNamed","findUp","BaseProcessor","collectExportsAndImports","explicitImport","isNotNull","mutate","collectTemplateDependencies","extractExpression","getSource","last","arr","length","zip","arr1","arr2","result","i","push","buildCodeFrameError","path","message","Error","findPackageJSON","pkgName","filename","pkgPath","require","resolve","paths","sync","cwd","er","code","undefined","definedTagsCache","Map","getDefinedTagsFromPackage","has","get","packageJSONPath","packageDir","packageJSON","JSON","parse","definedTags","linaria","tags","normalizedTags","Object","entries","reduce","acc","key","value","startsWith","set","isValidProcessorClass","module","constructor","getProcessorFromPackage","packageName","tagName","processorPath","Processor","default","getProcessorFromFile","getProcessorForIdentifier","imports","options","pathBinding","scope","getBinding","node","name","tagResolver","relatedImports","map","local","isIdentifier","isDescendant","binding","filter","isExpression","tagSource","tagPath","imported","source","p","customFile","processor","find","proc","getBuilderForIdentifier","params","prev","current","parentPath","isSequenceExpression","expressions","isCallExpression","callee","args","cookedArgs","arg","buildError","bind","type","extracted","evaluate","isMemberExpression","object","property","computed","isStringLiteral","isTaggedTemplateExpression","tag","quasis","expressionValues","replacer","replacement","isPure","replaceWith","addComment","astService","addDefaultImport","importedSource","nameHint","addNamedImport","loc","getDisplayName","idx","fileContext","displayName","parent","findParent","isObjectProperty","isJSXOpeningElement","isVariableDeclarator","toString","keyPath","isJSXIdentifier","id","test","replace","isTagReferenced","isReferenced","referencePaths","counters","WeakMap","getNextIndex","state","counter","cache","getTagProcessor","root","getProgramParent","builder","e","SKIP"],"sources":["../../src/utils/getTagProcessor.ts"],"sourcesContent":["import { readFileSync } from 'fs';\nimport { basename, dirname, join } from 'path';\n\nimport { types as t } from '@babel/core';\nimport { addDefault, addNamed } from '@babel/helper-module-imports';\nimport type { NodePath } from '@babel/traverse';\nimport type {\n  Expression,\n  SourceLocation,\n  Identifier,\n  MemberExpression,\n} from '@babel/types';\nimport findUp from 'find-up';\n\nimport { BaseProcessor } from '@linaria/tags';\nimport type {\n  Param,\n  Params,\n  IFileContext,\n  ExpressionValue,\n  TagSource,\n} from '@linaria/tags';\nimport type { IImport, StrictOptions } from '@linaria/utils';\nimport {\n  collectExportsAndImports,\n  explicitImport,\n  isNotNull,\n  mutate,\n} from '@linaria/utils';\n\nimport collectTemplateDependencies, {\n  extractExpression,\n} from './collectTemplateDependencies';\nimport getSource from './getSource';\n\ntype BuilderArgs = ConstructorParameters<typeof BaseProcessor> extends [\n  Params,\n  TagSource,\n  typeof t,\n  SourceLocation | null,\n  (replacement: Expression, isPure: boolean) => void,\n  ...infer T\n]\n  ? T\n  : never;\n\ntype Builder = (...args: BuilderArgs) => BaseProcessor;\n\ntype ProcessorClass = new (\n  ...args: ConstructorParameters<typeof BaseProcessor>\n) => BaseProcessor;\n\nconst last = <T>(arr: T[]): T | undefined => arr[arr.length - 1];\n\nfunction zip<T1, T2>(arr1: T1[], arr2: T2[]) {\n  const result: (T1 | T2)[] = [];\n  for (let i = 0; i < arr1.length; i++) {\n    result.push(arr1[i]);\n    if (arr2[i]) result.push(arr2[i]);\n  }\n\n  return result;\n}\n\nfunction buildCodeFrameError(path: NodePath, message: string): Error {\n  try {\n    return path.buildCodeFrameError(message);\n  } catch {\n    return new Error(message);\n  }\n}\n\nfunction findPackageJSON(pkgName: string, filename: string | null | undefined) {\n  try {\n    const pkgPath = require.resolve(\n      pkgName,\n      filename ? { paths: [dirname(filename)] } : {}\n    );\n    return findUp.sync('package.json', { cwd: pkgPath });\n  } catch (er: unknown) {\n    if (\n      typeof er === 'object' &&\n      er !== null &&\n      (er as { code?: unknown }).code === 'MODULE_NOT_FOUND'\n    ) {\n      return undefined;\n    }\n\n    throw er;\n  }\n}\n\nconst definedTagsCache = new Map<string, Record<string, string> | undefined>();\nconst getDefinedTagsFromPackage = (\n  pkgName: string,\n  filename: string | null | undefined\n): Record<string, string> | undefined => {\n  if (definedTagsCache.has(pkgName)) {\n    return definedTagsCache.get(pkgName);\n  }\n\n  const packageJSONPath = findPackageJSON(pkgName, filename);\n  if (!packageJSONPath) {\n    return undefined;\n  }\n\n  const packageDir = dirname(packageJSONPath);\n  const packageJSON = JSON.parse(readFileSync(packageJSONPath, 'utf8'));\n  const definedTags: Record<string, string> | undefined =\n    packageJSON.linaria?.tags;\n\n  const normalizedTags = definedTags\n    ? Object.entries(definedTags).reduce(\n        (acc, [key, value]) => ({\n          ...acc,\n          [key]: value.startsWith('.')\n            ? join(packageDir, value)\n            : require.resolve(value, { paths: [packageDir] }),\n        }),\n        {} as Record<string, string>\n      )\n    : undefined;\n\n  definedTagsCache.set(pkgName, normalizedTags);\n\n  return normalizedTags;\n};\n\nfunction isValidProcessorClass(module: unknown): module is ProcessorClass {\n  return module instanceof BaseProcessor.constructor;\n}\n\nfunction getProcessorFromPackage(\n  packageName: string,\n  tagName: string,\n  filename: string | null | undefined\n): ProcessorClass | null {\n  const definedTags = getDefinedTagsFromPackage(packageName, filename);\n  const processorPath = definedTags?.[tagName];\n  if (!processorPath) {\n    return null;\n  }\n\n  const Processor = require(processorPath).default;\n  if (!isValidProcessorClass(Processor)) {\n    return null;\n  }\n\n  return Processor;\n}\n\nfunction getProcessorFromFile(processorPath: string): ProcessorClass | null {\n  const Processor = require(processorPath).default;\n  if (!isValidProcessorClass(Processor)) {\n    return null;\n  }\n\n  return Processor;\n}\n\nfunction getProcessorForIdentifier(\n  path: NodePath<Identifier>,\n  imports: IImport[],\n  filename: string | null | undefined,\n  options: Pick<\n    StrictOptions,\n    'classNameSlug' | 'displayName' | 'evaluate' | 'tagResolver'\n  >\n):\n  | [ProcessorClass, TagSource, NodePath<Identifier | MemberExpression>]\n  | [null, null, null] {\n  const pathBinding = path.scope.getBinding(path.node.name);\n  if (!pathBinding) {\n    // It's not a binding, so it's not a tag\n    return [null, null, null];\n  }\n\n  const tagResolver = options.tagResolver ?? (() => null);\n\n  // FIXME: can be simplified\n  const relatedImports = imports\n    .map(\n      (i): [IImport, NodePath<Identifier | MemberExpression> | null] | null => {\n        const { local } = i;\n\n        if (local === path) {\n          return [i, null];\n        }\n\n        if (!local.isIdentifier()) {\n          if (path.isDescendant(local)) {\n            return [i, local];\n          }\n\n          return null;\n        }\n\n        const binding = local.scope.getBinding(local.node.name);\n        if (pathBinding === binding) {\n          return [i, path];\n        }\n\n        return null;\n      }\n    )\n    .filter(isNotNull)\n    .filter((i) => i[1] === null || i[1].isExpression());\n\n  if (relatedImports.length === 0) {\n    return [null, null, null];\n  }\n\n  const [Processor = null, tagSource = null, tagPath = null] =\n    relatedImports\n      .map(\n        ([{ imported, source }, p]): [\n          ProcessorClass | null,\n          TagSource,\n          NodePath<Identifier | MemberExpression> | null\n        ] => {\n          const customFile = tagResolver(source, imported);\n          const processor = customFile\n            ? getProcessorFromFile(customFile)\n            : getProcessorFromPackage(source, imported, filename);\n          return [processor, { imported, source }, p];\n        }\n      )\n      .find(([proc]) => proc) ?? [];\n\n  return Processor === null || tagSource === null || tagPath === null\n    ? [null, null, null]\n    : [Processor, tagSource, tagPath];\n}\n\nfunction getBuilderForIdentifier(\n  path: NodePath<Identifier>,\n  imports: IImport[],\n  filename: string | null | undefined,\n  options: Pick<\n    StrictOptions,\n    'classNameSlug' | 'displayName' | 'evaluate' | 'tagResolver'\n  >\n): Builder | null {\n  const [Processor, tagSource, tagPath] = getProcessorForIdentifier(\n    path,\n    imports,\n    filename,\n    options\n  );\n\n  if (!Processor || !tagSource || !tagPath) {\n    return null;\n  }\n\n  const params: Param[] = [['callee', tagPath.node]];\n  let prev: NodePath = tagPath;\n  let current: NodePath | null = tagPath.parentPath;\n  while (current && current !== path) {\n    if (\n      current?.isSequenceExpression() &&\n      last(current.node.expressions) === prev.node\n    ) {\n      prev = current;\n      current = current.parentPath;\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    if (current?.isCallExpression({ callee: prev.node })) {\n      const args = current.get('arguments');\n      const cookedArgs = args\n        .map((arg) => {\n          const buildError = arg.buildCodeFrameError.bind(arg);\n          if (!arg.isExpression()) {\n            throw buildError(`Unexpected type of an argument ${arg.type}`);\n          }\n          const source = getSource(arg);\n          const extracted = extractExpression(arg, options.evaluate);\n          return {\n            ...extracted,\n            source,\n            buildCodeFrameError: buildError,\n          } as ExpressionValue;\n        })\n        .filter(isNotNull);\n\n      params.push(['call', ...cookedArgs]);\n      prev = current;\n      current = current.parentPath;\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    if (current?.isMemberExpression({ object: prev.node })) {\n      const property = current.get('property');\n      if (property.isIdentifier() && !current.node.computed) {\n        params.push(['member', property.node.name]);\n      } else if (property.isStringLiteral()) {\n        params.push(['member', property.node.value]);\n      } else {\n        throw property.buildCodeFrameError(`Unexpected type of a property`);\n      }\n\n      prev = current;\n      current = current.parentPath;\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    if (current?.isTaggedTemplateExpression({ tag: prev.node })) {\n      const [quasis, expressionValues] = collectTemplateDependencies(\n        current,\n        options.evaluate\n      );\n      params.push(['template', zip(quasis, expressionValues)]);\n\n      prev = current;\n      current = current.parentPath;\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    break;\n  }\n\n  const replacer = (replacement: Expression, isPure: boolean) => {\n    mutate(prev, (p) => {\n      p.replaceWith(replacement);\n      if (isPure) {\n        p.addComment('leading', '#__PURE__');\n      }\n    });\n  };\n\n  const astService = {\n    ...t,\n    addDefaultImport: (importedSource: string, nameHint?: string) =>\n      addDefault(path, importedSource, { nameHint }),\n    addNamedImport: (\n      name: string,\n      importedSource: string,\n      nameHint: string = name\n    ) => addNamed(path, name, importedSource, { nameHint }),\n  };\n\n  return (...args: BuilderArgs) =>\n    new Processor(\n      params,\n      tagSource,\n      astService,\n      tagPath.node.loc ?? null,\n      replacer,\n      ...args\n    );\n}\n\nfunction getDisplayName(\n  path: NodePath<Identifier>,\n  idx: number,\n  fileContext: IFileContext\n): string {\n  let displayName: string | undefined;\n\n  const parent = path.findParent(\n    (p) =>\n      p.isObjectProperty() ||\n      p.isJSXOpeningElement() ||\n      p.isVariableDeclarator()\n  );\n\n  if (parent) {\n    if (parent.isObjectProperty()) {\n      if ('name' in parent.node.key) {\n        displayName = parent.node.key.name;\n      } else if ('value' in parent.node.key) {\n        displayName = parent.node.key.value.toString();\n      } else {\n        const keyPath = parent.get('key');\n        displayName = getSource(keyPath);\n      }\n    } else if (parent.isJSXOpeningElement()) {\n      const name = parent.get('name');\n      if (name.isJSXIdentifier()) {\n        displayName = name.node.name;\n      }\n    } else if (parent.isVariableDeclarator()) {\n      const id = parent.get('id');\n      if (id.isIdentifier()) {\n        displayName = id.node.name;\n      }\n    }\n  }\n\n  if (!displayName) {\n    const filename = fileContext.filename ?? 'unknown';\n    // Try to derive the path from the filename\n    displayName = basename(filename);\n\n    if (/^index\\.[a-z\\d]+$/.test(displayName)) {\n      // If the file name is 'index', better to get name from parent folder\n      displayName = basename(dirname(filename));\n    }\n\n    // Remove the file extension\n    displayName = displayName.replace(/\\.[a-z\\d]+$/, '');\n\n    if (displayName) {\n      displayName += idx;\n    } else {\n      throw new Error(\n        \"Couldn't determine a name for the component. Ensure that it's either:\\n\" +\n          '- Assigned to a variable\\n' +\n          '- Is an object property\\n' +\n          '- Is a prop in a JSX element\\n'\n      );\n    }\n  }\n\n  return displayName;\n}\n\nfunction isTagReferenced(path: NodePath): boolean {\n  // Check if the variable is referenced anywhere for basic DCE\n  // Only works when it's assigned to a variable\n  let isReferenced = true;\n\n  const parent = path.findParent(\n    (p) =>\n      p.isObjectProperty() ||\n      p.isJSXOpeningElement() ||\n      p.isVariableDeclarator()\n  );\n\n  if (parent) {\n    if (parent.isVariableDeclarator()) {\n      const id = parent.get('id');\n      // FIXME: replace with id.isReferencedIdentifier()\n      if (id.isIdentifier()) {\n        const { referencePaths } = path.scope.getBinding(id.node.name) || {\n          referencePaths: [],\n        };\n\n        isReferenced = referencePaths.length !== 0;\n      }\n    }\n  }\n\n  return isReferenced;\n}\n\nconst counters = new WeakMap<IFileContext, number>();\nconst getNextIndex = (state: IFileContext) => {\n  const counter = counters.get(state) ?? 0;\n  counters.set(state, counter + 1);\n  return counter;\n};\n\nconst cache = new WeakMap<Identifier, BaseProcessor | null>();\n\nexport default function getTagProcessor(\n  path: NodePath<Identifier>,\n  fileContext: IFileContext,\n  options: Pick<\n    StrictOptions,\n    'classNameSlug' | 'displayName' | 'evaluate' | 'tagResolver'\n  >\n): BaseProcessor | null {\n  if (!cache.has(path.node)) {\n    const root = path.scope.getProgramParent().path;\n    const { imports } = collectExportsAndImports(root);\n    try {\n      const builder = getBuilderForIdentifier(\n        path,\n        imports.filter(explicitImport),\n        fileContext.filename,\n        options\n      );\n      if (builder) {\n        // Increment the index of the style we're processing\n        // This is used for slug generation to prevent collision\n        // Also used for display name if it couldn't be determined\n        const idx = getNextIndex(fileContext);\n\n        const displayName = getDisplayName(path, idx, fileContext);\n\n        const processor = builder(\n          displayName,\n          isTagReferenced(path),\n          idx,\n          options,\n          fileContext\n        );\n\n        cache.set(path.node, processor);\n      } else {\n        cache.set(path.node, null);\n      }\n    } catch (e) {\n      if (e === BaseProcessor.SKIP) {\n        cache.set(path.node, null);\n        return null;\n      }\n\n      if (e instanceof Error) {\n        throw buildCodeFrameError(path, e.message);\n      }\n\n      throw e;\n    }\n  }\n\n  return cache.get(path.node) ?? null;\n}\n"],"mappings":"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"}