{"version":3,"file":"ModuleQueue.js","names":["relative","sep","createCustomDebug","getFileIdx","peek","arr","length","undefined","hasLessPriority","name","nameA","stackA","refCountA","nameB","stackB","refCountB","firstA","firstB","distanceA","split","distanceB","nameOf","entrypoint","keyOf","ModuleQueue","data","keys","Map","constructor","log","size","delete","key","idx","get","pop","clear","updateKey","heapifyDown","heapifyUp","i","leftIdx","rightIdx","largestIdx","swap","Math","floor","increaseKey","el","i1","i2","tmp","set","dequeue","max","last","map","enqueue","refCount","replacement","only","Set","isEmpty"],"sources":["../../../src/transform-stages/helpers/ModuleQueue.ts"],"sourcesContent":["import { relative, sep } from 'path';\n\nimport type { CustomDebug } from '@linaria/logger';\nimport { createCustomDebug } from '@linaria/logger';\nimport { getFileIdx } from '@linaria/utils';\n\nexport interface IEntrypoint {\n  code: string;\n  name: string;\n  only: string[];\n}\n\ntype Node = [entrypoint: IEntrypoint, stack: string[], refCount?: number];\n\nconst peek = <T>(arr: T[]) =>\n  arr.length > 0 ? arr[arr.length - 1] : undefined;\n\nconst hasLessPriority = (\n  [{ name: nameA }, stackA, refCountA = 0]: Node,\n  [{ name: nameB }, stackB, refCountB = 0]: Node\n) => {\n  const firstA = peek(stackA);\n  const firstB = peek(stackB);\n  if (refCountA === refCountB && firstA && firstB) {\n    const distanceA = relative(firstA, nameA).split(sep).length;\n    const distanceB = relative(firstB, nameB).split(sep).length;\n    return distanceA > distanceB;\n  }\n\n  return refCountA > refCountB;\n};\n\nconst nameOf = ([entrypoint]: Node): string => entrypoint.name;\n\nconst keyOf = ([entrypoint]: Node): string => {\n  return entrypoint.name;\n};\n\nexport class ModuleQueue {\n  private data: Array<Node> = [];\n\n  private keys: Map<string, number> = new Map();\n\n  private readonly log: CustomDebug;\n\n  constructor(entrypoint: IEntrypoint) {\n    this.data = [[entrypoint, []]];\n    this.log = createCustomDebug('transform', getFileIdx(entrypoint.name));\n\n    this.log('queue', 'Created for entrypoint %s', entrypoint.name);\n  }\n\n  private get size() {\n    return this.data.length;\n  }\n\n  private delete(key: string) {\n    const idx = this.keys.get(key);\n    if (idx === undefined) return;\n\n    if (idx === this.size - 1) {\n      this.data.pop();\n      this.keys.delete(key);\n      return;\n    }\n\n    if (this.size <= 1) {\n      this.data = [];\n      this.keys.clear();\n      return;\n    }\n\n    this.data[idx] = this.data.pop()!;\n    this.keys.delete(key);\n    this.updateKey(idx + 1);\n    this.heapifyDown(1);\n    this.heapifyUp(this.size);\n  }\n\n  private heapifyDown(i = 1): void {\n    const leftIdx = 2 * i;\n    const rightIdx = 2 * i + 1;\n    let largestIdx = i;\n\n    if (\n      leftIdx <= this.size &&\n      hasLessPriority(this.data[largestIdx - 1], this.data[leftIdx - 1])\n    ) {\n      largestIdx = leftIdx;\n    }\n\n    if (\n      rightIdx <= this.size &&\n      hasLessPriority(this.data[largestIdx - 1], this.data[rightIdx - 1])\n    ) {\n      largestIdx = rightIdx;\n    }\n\n    if (largestIdx !== i) {\n      this.swap(i, largestIdx);\n      this.heapifyDown(largestIdx);\n    }\n  }\n\n  private heapifyUp(i: number) {\n    let idx = i;\n    while (\n      idx > 1 &&\n      hasLessPriority(this.data[Math.floor(idx / 2) - 1], this.data[idx - 1])\n    ) {\n      this.swap(Math.floor(idx / 2), idx);\n      idx = Math.floor(idx / 2);\n    }\n  }\n\n  private increaseKey(i: number, el: Node) {\n    this.data[i - 1] = el;\n    this.updateKey(i);\n    this.heapifyUp(i);\n  }\n\n  private swap(i1: number, i2: number) {\n    const tmp = this.data[i1 - 1];\n    this.data[i1 - 1] = this.data[i2 - 1];\n    this.data[i2 - 1] = tmp;\n\n    this.updateKey(i1);\n    this.updateKey(i2);\n  }\n\n  private updateKey(i: number) {\n    this.keys.set(keyOf(this.data[i - 1]), i - 1);\n  }\n\n  public dequeue(): Node | undefined {\n    if (this.size === 0) return undefined;\n    const max = this.data[0];\n    if (this.size === 1) {\n      this.data = [];\n      this.keys.clear();\n      this.log('queue', 'Dequeued %s', nameOf(max));\n      return max;\n    }\n\n    const last = this.data.pop();\n    if (last !== undefined) {\n      this.data[0] = last;\n      this.updateKey(1);\n      this.heapifyDown(1);\n    }\n\n    this.keys.delete(keyOf(max));\n    this.log('queue', 'Dequeued %s: %o', nameOf(max), this.data.map(nameOf));\n    return max;\n  }\n\n  public enqueue(el: Node) {\n    const key = keyOf(el);\n    const idx = this.keys.get(key);\n    if (idx !== undefined) {\n      const [entrypoint, , refCount = 0] = this.data[idx];\n      this.delete(key);\n      this.log('queue', 'Increase refCount of %s to %d', key, refCount + 1);\n      const replacement = {\n        ...entrypoint,\n        only: [...new Set([...entrypoint.only, ...el[0].only])],\n      };\n\n      this.enqueue([replacement, el[1], refCount + 1]);\n      return;\n    }\n\n    this.increaseKey(this.size + 1, el);\n    this.log('queue', 'Enqueued %s: %o', nameOf(el), this.data.map(nameOf));\n  }\n\n  public isEmpty() {\n    return this.size === 0;\n  }\n}\n"],"mappings":"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"}