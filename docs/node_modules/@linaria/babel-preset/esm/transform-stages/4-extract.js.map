{"version":3,"file":"4-extract.js","names":["path","SourceMapGenerator","stylis","STYLIS_DECLARATION","posixSep","posix","sep","transformUrl","url","outputFilename","sourceFilename","platformPath","relative","dirname","resolve","split","join","extractCssFromAst","rules","originalCode","options","mappings","cssText","preprocessor","selector","text","use","context","decl","replace","match","p1","p2","p3","p4","filename","Object","keys","forEach","index","push","generated","line","column","original","start","name","source","atom","cssSourceMapText","length","generator","file","mapping","addMapping","setSourceContent","toString","extractStage","processors","allRules","allReplacements","processor","artifacts","artifact","replacements"],"sources":["../../src/transform-stages/4-extract.ts"],"sourcesContent":["import path from 'path';\n\nimport type { Mapping } from 'source-map';\nimport { SourceMapGenerator } from 'source-map';\nimport stylis from 'stylis';\n\nimport type { BaseProcessor, Replacements } from '@linaria/tags';\n\nimport type { Rules, Options, PreprocessorFn } from '../types';\n\nconst STYLIS_DECLARATION = 1;\nconst posixSep = path.posix.sep;\n\nexport function transformUrl(\n  url: string,\n  outputFilename: string,\n  sourceFilename: string,\n  platformPath: typeof path = path\n) {\n  // Replace asset path with new path relative to the output CSS\n  const relative = platformPath.relative(\n    platformPath.dirname(outputFilename),\n    // Get the absolute path to the asset from the path relative to the JS file\n    platformPath.resolve(platformPath.dirname(sourceFilename), url)\n  );\n\n  if (platformPath.sep === posixSep) {\n    return relative;\n  }\n\n  return relative.split(platformPath.sep).join(posixSep);\n}\n\nfunction extractCssFromAst(\n  rules: Rules,\n  originalCode: string,\n  options: Options\n) {\n  const mappings: Mapping[] = [];\n\n  let cssText = '';\n\n  let preprocessor: PreprocessorFn;\n  if (typeof options.preprocessor === 'function') {\n    // eslint-disable-next-line prefer-destructuring\n    preprocessor = options.preprocessor;\n  } else {\n    switch (options.preprocessor) {\n      case 'none':\n        preprocessor = (selector, text) => `${selector} {${text}}\\n`;\n        break;\n      case 'stylis':\n      default:\n        stylis.use(null)((context, decl) => {\n          const { outputFilename } = options;\n          if (context === STYLIS_DECLARATION && outputFilename) {\n            // When writing to a file, we need to adjust the relative paths inside url(..) expressions\n            // It'll allow css-loader to resolve an imported asset properly\n            return decl.replace(\n              /\\b(url\\(([\"']?))(\\.[^)]+?)(\\2\\))/g,\n              (match, p1, p2, p3, p4) =>\n                p1 + transformUrl(p3, outputFilename, options.filename) + p4\n            );\n          }\n\n          return decl;\n        });\n\n        preprocessor = stylis;\n    }\n  }\n\n  Object.keys(rules).forEach((selector, index) => {\n    mappings.push({\n      generated: {\n        line: index + 1,\n        column: 0,\n      },\n      original: rules[selector].start!,\n      name: selector,\n      source: '',\n    });\n\n    if (rules[selector].atom) {\n      // For atoms, we just directly insert cssText, to give the atomizer full control over the rules\n      cssText += `${rules[selector].cssText}\\n`;\n    } else {\n      // Run each rule through stylis to support nesting\n      cssText += `${preprocessor(selector, rules[selector].cssText)}\\n`;\n    }\n  });\n\n  return {\n    cssText,\n    rules,\n\n    get cssSourceMapText() {\n      if (mappings?.length) {\n        const generator = new SourceMapGenerator({\n          file: options.filename.replace(/\\.js$/, '.css'),\n        });\n\n        mappings.forEach((mapping) =>\n          generator.addMapping({ ...mapping, source: options.filename })\n        );\n\n        generator.setSourceContent(options.filename, originalCode);\n\n        return generator.toString();\n      }\n\n      return '';\n    },\n  };\n}\n\n/**\n * Extract artifacts (e.g. CSS) from processors\n */\nexport default function extractStage(\n  processors: BaseProcessor[],\n  originalCode: string,\n  options: Options\n) {\n  let allRules: Rules = {};\n  const allReplacements: Replacements = [];\n  processors.forEach((processor) => {\n    processor.artifacts.forEach((artifact) => {\n      if (artifact[0] !== 'css') return;\n      const [rules, replacements] = artifact[1] as [\n        rules: Rules,\n        sourceMapReplacements: Replacements\n      ];\n\n      allRules = {\n        ...allRules,\n        ...rules,\n      };\n\n      allReplacements.push(...replacements);\n    });\n  });\n\n  return {\n    ...extractCssFromAst(allRules, originalCode, options),\n    replacements: allReplacements,\n  };\n}\n"],"mappings":"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"}